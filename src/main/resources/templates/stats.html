<html xmlns:th="http://www.thymeleaf.org">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <style>
        body {
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            background-color: #c3c3c3;
            font-family: 'Inconsolata', monospace;
        }

        .container {
            text-align: center;
            width: 100%;
        }

        .panelData {
            text-align: center;
            background: white;
            width: 70%;
            display: inline-block;
            padding: 15px;
        }

        #divError {
            display: none;
            padding: 5px;
            background: rgb(255, 122, 122);
            color: rgb(51, 35, 35);
            margin-bottom: 20px;
        }

        #divSearching {
            display: none;
            padding: 5px;
            background: rgb(255, 255, 122);
            color: rgb(51, 35, 35);
            margin-bottom: 20px;
        }

        #btnBack {
            background: rgb(232, 255, 100);
        }

        #divContainerMinDistance {
            display: inline-block;
            margin-left: 10px;
            background: #fbda94;
            padding: 10px;
            margin: 5px;
        }

        #divContainerMaxDistance {
            display: inline-block;
            margin-left: 10px;
            background: #a5ccff;
            padding: 10px;
            margin: 5px;
        }

        #divContainerAverageDistance {
            display: inline-block;
            margin-left: 10px;
            background: #f9fb94;
            padding: 10px;
            margin: 5px;
        }

        .bold {
            font-weight: bold;
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="panelData">
            <h1>Estadística - Api geoMeli </h1>
            <div>
                <div id="divError">
                </div>
                <div id="divSearching">
                    Buscando Datos...
                </div>
                <input id="btnBack" type="button" value="volver" onclick="window.location.assign('/');"></button>
                <input id="btnSubmit" type="button" value="Actualizar estadística" onclick="loadAllStats();"></button>
            </div>
            <figure class="highcharts-figure">
                <div id="container"></div>
                <div style="width: 100%;">
                    <div id="divContainerMinDistance">
                        <div>País con mínima distancia</div>
                        <label id="lblMinDistance" class="bold"></label>
                    </div>
                    <div id="divContainerMaxDistance">
                        <div>País con máxima distancia</div>
                        <label id="lblMaxDistance" class="bold"></label>
                    </div>
                    <div id="divContainerAverageDistance">
                        <div>Promedio de distancias</div>
                        <label id="lblDistanceAverage" class="bold"></label>
                    </div>
                </div>
            </figure>
        </div>
    </div>
    <script>

        $(document).ready(function () {
            loadAllStats();
        })

        function loadAllStats() {
            getCountryMinDistance()
            getCountryMaxDistance();
            getDistanceAverage();
            generateStatistic();
        }

        function getDistanceAverage() {
            $.ajax({
                url: "http://localhost:8080/api/stats/average",
                method: "POST",
                timeout: 0,
                dataType: "json",
                headers: {
                    "Content-Type": "application/javascript"
                },
                success: function (data) {
                    if(data.success){
                        if(data.result != null)
                            document.getElementById("lblDistanceAverage").innerHTML = `${data.result} km.`;
                    }
                }, error: function (err) {
                    document.getElementById("lblDistanceAverage").innerHTML = "No encontrado";
                }
            })
        }

        function getCountryMinDistance() {
            $.ajax({
                url: "http://localhost:8080/api/stats/min",
                method: "POST",
                timeout: 0,
                dataType: "json",
                headers: {
                    "Content-Type": "application/javascript"
                },
                success: function (data) {
                    if(data.success){
                        if(data.country != null)
                        document.getElementById("lblMinDistance").innerHTML = `${data.country.name} (${data.country.distanceToArgentina} km.)`;
                    }
                }, error: function (err) {
                    document.getElementById("lblMinDistance").innerHTML = "No encontrado";
                }
            })
        }

        function getCountryMaxDistance() {
            $.ajax({
                url: "http://localhost:8080/api/stats/max",
                method: "POST",
                timeout: 0,
                dataType: "json",
                headers: {
                    "Content-Type": "application/javascript"
                },
                success: function (data) {
                    if(data.success){
                        if(data.country != null)
                            document.getElementById("lblMaxDistance").innerHTML = `${data.country.name} (${data.country.distanceToArgentina} km.)`;
                    }
                }, error: function (err) {
                    document.getElementById("lblMaxDistance").innerHTML = "No encontrado";
                }
            })
        }

        function generateStatistic() {
            $.ajax({
                url: "http://localhost:8080/api/stats",
                method: "POST",
                timeout: 0,
                dataType: "json",
                headers: {
                    "Content-Type": "application/javascript"
                },
                success: function (data) {
                    if(data.success){
                        var series = new Array();
                        Array.from(data.countries).map(country => {
                            series.push(new Object({
                                name: `${country.name} <br>(${country.distanceToArgentina} km.)`,
                                y: country.requestCount
                            }))
                        })

                        char(series);
                    }
                }, error: function (err) {

                }
            })
        }

        function char(var_series) {
            Highcharts.chart('container', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: 'Ranking de request por paises'
                },
                subtitle: {
                    text: ''
                },
                accessibility: {
                    announceNewData: {
                        enabled: true
                    }
                },
                xAxis: {
                    type: 'category'
                },
                yAxis: {
                    title: {
                        text: 'Cantidad'
                    }
                },
                legend: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            format: '{point.y}'
                        }
                    }
                },

                tooltip: {
                    pointFormat: '<b>{point.y}</b> ip request<br/>'
                },

                series: [
                    {
                        colorByPoint: true,
                        data:
                            var_series
                    }
                ]
            });
        }
    </script>
</body>

</html>